name: Release APKs

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build ArcPlayer Release APK
      run: ./gradlew assembleRelease
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Rename APK
      # The build.gradle archivesBaseName is ArcPlayer.v${versionName}, so the path is app/build/outputs/apk/release/ArcPlayer.v${versionName}.apk
      # We need to find the exact file name if we don't know the full version name.
      # A safer way is to rely on the build.gradle change that makes it single-output.
      run: |
        mv app/build/outputs/apk/release/*.apk app/build/outputs/apk/ArcPlayer-${{ steps.get_version.outputs.VERSION }}-universal-release.apk
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: ğŸ¬ ArcPlayer v${{ steps.get_version.outputs.VERSION }}
        body: |
          # ğŸ¬ ArcPlayer v${{ steps.get_version.outputs.VERSION }}
          
          Simple and lightweight, yet polished and powerful Android video player based on ExoPlayer.
          
          ## â¬‡ï¸ Downloads
          
          | APK | Description |
          |-----|-------------|
          | **ArcPlayer** | Unified ArcPlayer branding |
          
          ## âœ¨ Features
          
          - ğŸ¯ **5-tier Intro Skip** - AnimeSkip, SkipDB, IntroHater, AniSkip, IntroDB
          - ğŸ“Š **Trakt Scrobbling** - Auto-track your watch history
          - ğŸŒ **Remote Web UI** - Submit timestamps from your phone
          - ğŸ¥ **Format Support** - HEVC, HDR, Dolby Vision, Atmos
          
          ## ğŸ”‘ Requirements
          
          - IntroHater requires your debrid API key (TorBox, Real-Debrid, etc.)
          - Trakt requires OAuth setup in settings
          
          ---
          
          <p align="center">
            <a href="https://discord.gg/njSKPUQtFa">ğŸ’¬ Join Discord</a> â€¢
            Made with â¤ï¸ by <b>Cxsmo_AI</b>
          </p>
        files: |
          app/build/outputs/apk/ArcPlayer-${{ steps.get_version.outputs.VERSION }}-universal-release.apk
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
